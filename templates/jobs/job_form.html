{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<style>
    .form-input {
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        appearance: none;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        width: 100%;
        padding: 0.75rem 1rem;
        color: #1f2937;
        line-height: 1.5;
        background-color: #fff;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea {
        min-height: 12rem;
    }
</style>

<div class="min-h-screen bg-gray-50 py-12">
    <div class="container mx-auto px-4 max-w-6xl">
        <div class="flex justify-center">
            <!-- MAIN FORM COMPONENT: Centered and standard width -->
            <div class="w-full max-w-4xl bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden relative">
                <!-- HEADER WITH SMART IMPORT BUTTON -->
                <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-white">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">
                            {% if form.instance.pk %}Edit Job Posting{% else %}Create New Job Posting{% endif %}
                        </h1>
                        <p class="text-gray-500 mt-1 text-sm">Fill in the details below.</p>
                    </div>
                    <button type="button" id="btnOpenImportModal"
                        class="bg-indigo-50 text-indigo-700 hover:bg-indigo-100 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition border border-indigo-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l-.9-1.352A1 1 0 0011 13H9a1 1 0 00-.88.648L7.22 15H5a2 2 0 01-2-2V5zm5.77 7.5a3.001 3.001 0 002.46 0h2.24A1 1 0 0018 10V5a1 1 0 00-1-1H3a1 1 0 00-1 1v5a1 1 0 001 1h2.24a3.001 3.001 0 002.46 0h.07zM10 8a1 1 0 100-2 1 1 0 000 2z"
                                clip-rule="evenodd" />
                        </svg>
                        âœ¨ Smart Import
                    </button>
                </div>

                <div class="p-8">
                    <form method="post">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                        <div class="bg-red-50 text-red-700 p-4 mb-6 rounded border border-red-200">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <div class="space-y-6">
                            <!-- TITLE -->
                            <div>
                                <label class="block font-bold text-gray-700 mb-2"
                                    for="{{ form.title.id_for_label }}">Title</label>
                                {{ form.title|add_class:"form-input" }}
                                {{ form.title.errors }}
                            </div>

                            <!-- COMPANY & LOCATION -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block font-bold text-gray-700 mb-2"
                                        for="{{ form.company.id_for_label }}">Company <span
                                            class="text-red-500">*</span></label>
                                    {{ form.company|add_class:"form-input" }}
                                    {{ form.company.errors }}
                                </div>
                                <div>
                                    <label class="block font-bold text-gray-700 mb-2"
                                        for="{{ form.location.id_for_label }}">Location</label>
                                    {{ form.location|add_class:"form-input" }}
                                    {{ form.location.errors }}
                                </div>
                            </div>

                            <!-- ORIGINAL LINK -->
                            <div>
                                <label class="block font-bold text-gray-700 mb-2"
                                    for="{{ form.original_link.id_for_label }}">Job Posting URL <span
                                        class="text-red-500">*</span></label>
                                {{ form.original_link|add_class:"form-input" }}
                                <p class="text-sm text-gray-500 mt-1">The URL where this job was originally found.</p>
                                {{ form.original_link.errors }}
                            </div>

                            <!-- DESCRIPTION -->
                            <div>
                                <label class="block font-bold text-gray-700 mb-2"
                                    for="{{ form.description.id_for_label }}">Description</label>
                                {{ form.description|add_class:"form-input form-textarea" }}
                                <p class="text-sm text-gray-500 mt-1">Full job description text.</p>
                                {{ form.description.errors }}
                            </div>

                            <!-- METADATA -->
                            <div>
                                <label class="block font-bold text-gray-700 mb-2">Marketing Roles</label>
                                <!-- Hidden default rendering to keep form logic intact, but we'll manipulate it with JS -->
                                <div id="hidden-checkboxes" class="hidden">
                                    {% for checkbox in form.marketing_roles %}
                                    <div class="marketing-role-checkbox" data-label="{{ checkbox.choice_label }}">
                                        {{ checkbox.tag }}
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- Minimalist Pill UI -->
                                <div id="marketing-role-pills" class="flex flex-wrap gap-2 mt-2">
                                    <!-- Pills will be injected here by JS -->
                                </div>
                                {{ form.marketing_roles.errors }}
                            </div>
                            <div>
                                <label class="block font-bold text-gray-700 mb-2"
                                    for="{{ form.job_type.id_for_label }}">Job Type</label>
                                {{ form.job_type|add_class:"form-input" }}
                            </div>
                            <div>
                                <label class="block font-bold text-gray-700 mb-2"
                                    for="{{ form.salary_range.id_for_label }}">Salary Range</label>
                                {{ form.salary_range|add_class:"form-input" }}
                            </div>
                            <div>
                                <label class="block font-bold text-gray-700 mb-2"
                                    for="{{ form.status.id_for_label }}">Status</label>
                                {{ form.status|add_class:"form-input" }}
                            </div>
                        </div>
                </div>

                <!-- BUTTONS -->
                <div class="mt-10 flex items-center justify-end gap-4 border-t px-8 py-6 bg-gray-50">
                    <a href="{% url 'job-list' %}" class="text-gray-600 font-medium hover:underline">Cancel</a>
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded shadow transition transform hover:-translate-y-0.5">
                        {% if form.instance.pk %}Save Changes{% else %}Publish Job{% endif %}
                    </button>
                </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- SMART IMPORT MODAL -->
<div id="importModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <!-- Overlay -->
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" aria-hidden="true"
            id="modalOverlay">
        </div>

        <!-- This element is to trick the browser into centering the modal contents. -->
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <!-- Modal Content -->
        <div
            class="relative inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-gray-200">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-bold text-gray-900" id="modal-title">
                            Import from Raw Data
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 mb-3">
                                Paste the raw job description below. We'll automatically identify the title and fill
                                the description.
                            </p>
                            <textarea id="rawJD" rows="10"
                                class="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3"
                                placeholder="Paste full JD here..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-100">
                <button type="button" id="btnSmartFill"
                    class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm transition-colors">
                    Dump to Description
                </button>
                <button type="button" id="btnCloseImportModal"
                    class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Smart Import Modal Logic ---
        const btnOpenImportModal = document.getElementById('btnOpenImportModal');
        const importModal = document.getElementById('importModal');
        const btnCloseImportModal = document.getElementById('btnCloseImportModal');
        const modalOverlay = document.getElementById('modalOverlay');
        const btnSmartFill = document.getElementById('btnSmartFill');
        const rawJDInput = document.getElementById('rawJD');
        const titleField = document.getElementById('id_title');
        const descriptionField = document.getElementById('id_description');

        function openModal() {
            importModal.classList.remove('hidden');
        }

        function closeModal() {
            importModal.classList.add('hidden');
        }

        if (btnOpenImportModal) {
            btnOpenImportModal.addEventListener('click', openModal);
        }

        if (btnCloseImportModal) {
            btnCloseImportModal.addEventListener('click', closeModal);
        }

        if (modalOverlay) {
            modalOverlay.addEventListener('click', closeModal);
        }

        if (btnSmartFill) {
            btnSmartFill.addEventListener('click', function () {
                const rawText = rawJDInput.value;
                if (!rawText.trim()) {
                    alert('Please paste a job description first.');
                    return;
                }

                // Heuristic: First line as title if empty
                const lines = rawText.split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length > 0 && titleField && !titleField.value) {
                    if (lines[0].length < 100) titleField.value = lines[0];
                }

                // Dump all to description
                if (descriptionField) descriptionField.value = rawText;

                // Feedback & Close
                const originalText = btnSmartFill.innerText;
                btnSmartFill.innerText = 'Dumped!';
                btnSmartFill.classList.add('bg-green-600');

                setTimeout(() => {
                    btnSmartFill.innerText = originalText;
                    btnSmartFill.classList.remove('bg-green-600');
                    closeModal(); // Auto close on success
                }, 1000);
            });
        }

        // --- Minimalist Marketing Role Pills Logic ---
        const hiddenCheckboxes = document.querySelectorAll('.marketing-role-checkbox');
        const pillsContainer = document.getElementById('marketing-role-pills');

        if (hiddenCheckboxes.length > 0 && pillsContainer) {
            hiddenCheckboxes.forEach(wrapper => {
                const checkbox = wrapper.querySelector('input[type="checkbox"]');
                const label = wrapper.getAttribute('data-label');

                // Create Pill Button
                const pill = document.createElement('button');
                pill.type = 'button';
                pill.className = 'px-3 py-1.5 rounded-full text-sm font-medium transition border ' +
                    (checkbox.checked
                        ? 'bg-blue-600 border-blue-600 text-white shadow-md'
                        : 'bg-white border-gray-300 text-gray-700 hover:border-blue-400 hover:text-blue-600');
                pill.textContent = label;

                // Click Event
                pill.addEventListener('click', () => {
                    checkbox.checked = !checkbox.checked;
                    updatePillStyle(pill, checkbox.checked);
                });

                pillsContainer.appendChild(pill);
            });
        }

        function updatePillStyle(pill, isChecked) {
            if (isChecked) {
                pill.className = 'px-3 py-1.5 rounded-full text-sm font-medium transition border bg-blue-600 border-blue-600 text-white shadow-md transform scale-105';
            } else {
                pill.className = 'px-3 py-1.5 rounded-full text-sm font-medium transition border bg-white border-gray-300 text-gray-700 hover:border-blue-400 hover:text-blue-600';
            }
        }
    });
</script>
{% endblock %}