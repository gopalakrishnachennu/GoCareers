{% extends 'base.html' %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8">
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">LLM Log Detail</h1>
            <p class="text-gray-600">Full input and output for this request.</p>
        </div>
        <a href="{% url 'llm-logs' %}" class="text-sm text-blue-600 hover:underline">Back to logs</a>
    </div>

    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-700">
            <div><strong>Time:</strong> {{ log.created_at|date:"Y-m-d H:i:s" }}</div>
            <div><strong>Model:</strong> {{ log.model_name }}</div>
            <div><strong>Status:</strong> {% if log.success %}OK{% else %}Fail{% endif %}</div>
            <div><strong>Job:</strong> {% if log.job %}{{ log.job.title }}{% else %}—{% endif %}</div>
            <div><strong>Consultant:</strong> {% if log.consultant %}{{ log.consultant.user.get_full_name|default:log.consultant.user.username }}{% else %}—{% endif %}</div>
            <div><strong>Tokens:</strong> {{ log.total_tokens }}</div>
            <div><strong>Latency:</strong> {{ log.latency_ms }} ms</div>
            <div><strong>Cost:</strong> {{ log.cost_total|floatformat:6 }}</div>
            <div><strong>Request Type:</strong> {{ log.request_type }}</div>
        </div>
        {% if log.error_message %}
        <div class="mt-3 text-sm text-red-700"><strong>Error:</strong> {{ log.error_message }}</div>
        {% endif %}
    </div>

    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">System Prompt</h2>
        <pre class="whitespace-pre-wrap text-xs bg-gray-50 p-3 rounded border">{{ log.system_prompt }}</pre>
    </div>

    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">User Prompt</h2>
        <pre class="whitespace-pre-wrap text-xs bg-gray-50 p-3 rounded border">{{ log.user_prompt }}</pre>
    </div>

    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold text-gray-800">Request Payload</h2>
            <button id="copy-llm-payload"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-4 rounded-lg text-sm">
                Copy Payload
            </button>
        </div>
        <pre id="llm-payload" class="whitespace-pre-wrap text-xs bg-gray-50 p-3 rounded border">{{ log.request_payload }}</pre>
    </div>

    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">Response</h2>
        <pre class="whitespace-pre-wrap text-xs bg-gray-50 p-3 rounded border">{{ log.response_text }}</pre>
    </div>
</div>

<script>
    (function () {
        const btn = document.getElementById('copy-llm-payload');
        const payload = document.getElementById('llm-payload');
        if (!btn || !payload) return;
        btn.addEventListener('click', async () => {
            const text = payload.textContent || '';
            try {
                await navigator.clipboard.writeText(text);
                btn.textContent = 'Copied';
                setTimeout(() => btn.textContent = 'Copy Payload', 1500);
            } catch (e) {
                alert('Copy failed. Select text manually.');
            }
        });
    })();
</script>
{% endblock %}
