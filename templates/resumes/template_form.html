{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="template-page">
    <div class="template-hero">
        <div>
            <div class="template-eyebrow">Resume System</div>
            <h1 class="template-title">Template Studio</h1>
            <p class="template-subtitle">Define structure and control what AI can write.</p>
        </div>
    </div>

    <div class="template-grid">
        <div class="template-card">
            <h2 class="card-title">Template Details</h2>
            <form method="post">
                {% csrf_token %}
                <div class="form-row">
                    <label class="label">Name</label>
                    {% render_field form.name class="input" %}
                </div>
                <div class="form-row">
                    <label class="label">Description</label>
                    {% render_field form.description class="textarea" %}
                </div>
                <div class="form-row">
                    <label class="label">Marketing Roles</label>
                    {% render_field form.marketing_roles class="input" %}
                </div>
                <div class="form-row inline">
                    <label class="label">Is Active</label>
                    {% render_field form.is_active class="checkbox" %}
                </div>

                <div class="actions">
                    <button class="btn-primary">Save Template</button>
                    <a href="{% url 'resume-template-list' %}" class="btn-ghost">Cancel</a>
                </div>
            </form>
        </div>

        <div class="template-card">
            <div class="card-header">
                <h2 class="card-title">Layout Builder</h2>
                <button type="button" id="add-section" class="btn-secondary">Add Section</button>
            </div>

            <div id="sections" class="sections"></div>

            <div class="builder-footer">
                <div class="builder-note">AI is allowed only in sections marked AI.</div>
                <button type="button" id="apply-layout" class="btn-primary">Apply to JSON</button>
            </div>

            <div class="form-row">
                <label class="label">Layout (JSON)</label>
                {% render_field form.layout class="textarea code" id="layout-json" %}
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --ink: #0f172a;
        --muted: #64748b;
        --bg: #f4f2ee;
        --card: #ffffff;
        --accent: #0b5c9e;
        --accent-2: #0f766e;
        --border: #e2e8f0;
    }
    .template-page { background: var(--bg); min-height: 100vh; padding: 32px 24px 56px; }
    .template-hero { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .template-eyebrow { text-transform: uppercase; letter-spacing: 0.2em; font-size: 12px; color: var(--muted); }
    .template-title { font-size: 32px; font-weight: 800; color: var(--ink); margin: 6px 0; }
    .template-subtitle { color: var(--muted); font-size: 14px; }
    .template-grid { display: grid; grid-template-columns: 1fr 1.1fr; gap: 20px; }
    .template-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(15,23,42,0.06); }
    .card-title { font-size: 18px; font-weight: 700; color: var(--ink); margin-bottom: 12px; }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .form-row { margin-bottom: 14px; }
    .form-row.inline { display: flex; align-items: center; gap: 12px; }
    .label { display: block; font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .08em; }
    .input, .textarea, select { width: 100%; border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; font-size: 14px; }
    .textarea { min-height: 90px; }
    .textarea.code { font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; min-height: 180px; background: #f8fafc; }
    .checkbox { width: 18px; height: 18px; }
    .actions { display: flex; gap: 10px; margin-top: 12px; }
    .btn-primary { background: var(--accent); color: #fff; border: 0; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; }
    .btn-secondary { background: #e2e8f0; color: var(--ink); border: 0; padding: 8px 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .btn-ghost { border: 1px solid var(--border); padding: 10px 14px; border-radius: 10px; color: var(--ink); text-decoration: none; font-weight: 600; }
    .sections { display: grid; gap: 10px; }
    .section-row { border: 1px dashed var(--border); border-radius: 12px; padding: 12px; display: grid; grid-template-columns: 1.2fr 1fr 1fr auto; gap: 10px; align-items: center; }
    .pill { display: inline-flex; align-items: center; gap: 6px; background: #f1f5f9; border-radius: 999px; padding: 4px 10px; font-size: 12px; color: var(--ink); }
    .builder-footer { display: flex; justify-content: space-between; align-items: center; margin: 12px 0; }
    .builder-note { font-size: 12px; color: var(--muted); }
    @media (max-width: 980px) { .template-grid { grid-template-columns: 1fr; } }
    @media (max-width: 640px) { .section-row { grid-template-columns: 1fr; } }
    .remove-btn { background: #fee2e2; color: #991b1b; border: 0; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
</style>

<script>
    (function () {
        const layoutField = document.getElementById('layout-json');
        const sectionsEl = document.getElementById('sections');
        const addBtn = document.getElementById('add-section');
        const applyBtn = document.getElementById('apply-layout');

        const sectionTypes = ['header', 'summary', 'skills', 'experience', 'education'];

        const createRow = (data = {}) => {
            const row = document.createElement('div');
            row.className = 'section-row';

            const typeSel = document.createElement('select');
            sectionTypes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                if (data.type === t) opt.selected = true;
                typeSel.appendChild(opt);
            });

            const fixed = document.createElement('input');
            fixed.type = 'text';
            fixed.placeholder = 'Fixed fields (comma)';
            fixed.value = (data.fixed && Array.isArray(data.fixed)) ? data.fixed.join(',') : (data.fixed === true ? 'true' : '');

            const ai = document.createElement('input');
            ai.type = 'text';
            ai.placeholder = 'AI fields (comma)';
            ai.value = (data.ai && Array.isArray(data.ai)) ? data.ai.join(',') : (data.ai === true ? 'true' : '');

            const remove = document.createElement('button');
            remove.type = 'button';
            remove.className = 'remove-btn';
            remove.textContent = 'Remove';
            remove.addEventListener('click', () => row.remove());

            row.appendChild(typeSel);
            row.appendChild(fixed);
            row.appendChild(ai);
            row.appendChild(remove);
            sectionsEl.appendChild(row);
        };

        const parseLayout = () => {
            try {
                const json = JSON.parse(layoutField.value || '{}');
                const sections = json.sections || [];
                sectionsEl.innerHTML = '';
                sections.forEach(s => createRow(s));
            } catch (e) {
                // ignore
            }
        };

        const buildLayout = () => {
            const rows = Array.from(sectionsEl.querySelectorAll('.section-row'));
            const sections = rows.map(r => {
                const inputs = r.querySelectorAll('input, select');
                const type = inputs[0].value;
                const fixedRaw = inputs[1].value.trim();
                const aiRaw = inputs[2].value.trim();
                const fixed = fixedRaw === 'true' ? true : (fixedRaw ? fixedRaw.split(',').map(s => s.trim()).filter(Boolean) : undefined);
                const ai = aiRaw === 'true' ? true : (aiRaw ? aiRaw.split(',').map(s => s.trim()).filter(Boolean) : undefined);
                const section = { type };
                if (fixed !== undefined) section.fixed = fixed;
                if (ai !== undefined) section.ai = ai;
                return section;
            });
            layoutField.value = JSON.stringify({ sections }, null, 2);
        };

        addBtn?.addEventListener('click', () => createRow({ type: 'summary', ai: true }));
        applyBtn?.addEventListener('click', buildLayout);
        parseLayout();
        if (!layoutField.value) {
            createRow({ type: 'header', fixed: true });
            createRow({ type: 'summary', ai: true });
            createRow({ type: 'skills', ai: true });
            createRow({ type: 'experience', fixed: ['title','company','dates'], ai: ['responsibilities'] });
            createRow({ type: 'education', fixed: true });
            buildLayout();
        }
    })();
</script>
{% endblock %}
